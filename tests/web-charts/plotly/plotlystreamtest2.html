<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plotly Test</title>
  <script src="plotly-latest.min.js"></script>
</head>
<body>

<div id="graph" style="width:900px;height:600px;"></div>

<script>
  function rand() {
    return Math.random();
  }

  function getXAxisTimeRange(timestamp) {
    let time = timestamp.getTime();
    return [new Date(time - 10000), new Date(timestamp)]; // 10 seconds
  }

  let graphNode = document.getElementById('graph');

  // assumed time span is one minute
  const arrayLength = 60 * 1000 / 100; // 60 seconds * 1000 milliseconds / 100 milliseconds

  let timestamps = [];
  let now = new Date(); // TODO real time

  let massFlowRate = {
    x: timestamps,
    y: [],
    connectgaps: true,
    mode: 'lines+markers',
    name: 'Mass flow rate',
    marker: {
      color: '#0000ff',
      size: 8
    },
    line: {
      color: '#8888ff',
      width: 3,
      shape: 'linear',
      dash: 'solid'
    }
  };

  let flowVelocity = {
    x: timestamps,
    y: [],
    connectgaps: true,
    mode: 'lines+markers',
    name: 'Flow velocity',
    marker: {
      color: '#f61451',
      size: 8
    },
    line: {
      color: '#ff98e6',
      width: 3,
      shape: 'linear',
      dash: 'solid'
    }
  };

  let data = [massFlowRate, flowVelocity];

  let layout = {
    title: 'Some title',
    xaxis: {
      title: 'Timeline',
      type: 'date',
      showgrid: true,
      zeroline: false,
      range: getXAxisTimeRange(now),
      autorange: true,
      showline: true,
      showticklabels: true,
      linecolor: 'rgb(204,204,204)',
      linewidth: 2,
      autotick: false,
      ticks: 'outside',
      tickcolor: 'rgb(204,204,204)',
      tickwidth: 2,
      ticklen: 5,
      tickfont: {
        family: 'Arial',
        size: 12,
        color: 'rgb(82, 82, 82)'
      }
    },
    yaxis: {
      title: 'TODO'
    }
  };

  Plotly.newPlot(graphNode, data, layout);

  let interval = setInterval(function () {

    // fetch data via REST API

    now = new Date(); // TODO real time
    timestamps.push(now);
    if (timestamps.length > arrayLength) {
      timestamps.splice(0, 1);
    }

    massFlowRate.y.push(rand()); // TODO real value
    if (massFlowRate.y.length > arrayLength) {
      massFlowRate.y.splice(0, 1);
    }

    flowVelocity.y.push(rand()); // TODO real value
    if (flowVelocity.y.length > arrayLength) {
      flowVelocity.y.splice(0, 1);
    }

    let update = {
      x: [timestamps],
      y: [massFlowRate.y, flowVelocity.y]
    };

    Plotly.update(graphNode, update);

    var layout = {
      xaxis: {
        range: getXAxisTimeRange(now)
      }
    };

    Plotly.relayout(graphNode, layout); // updates the layout

  }, 100);
</script>

</body>
</html>
