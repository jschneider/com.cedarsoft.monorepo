<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
  <parent>
    <groupId>com.cedarsoft.tests</groupId>
    <artifactId>kotlinjs</artifactId>
    <version>0</version>
  </parent>

  <modelVersion>4.0.0</modelVersion>
  <artifactId>jsSampleClient</artifactId>
  <name>test.Kotlin JS Sample Client</name>

  <dependencies>
<!--    <dependency>-->
<!--      <groupId>com.cedarsoft.tests.kotlinjs</groupId>-->
<!--      <artifactId>sample-lib</artifactId>-->
<!--    </dependency>-->

    <dependency>
      <groupId>org.jetbrains.kotlin</groupId>
      <artifactId>kotlin-stdlib-js</artifactId>
    </dependency>
    <dependency>
      <groupId>org.jetbrains.kotlin</groupId>
      <artifactId>kotlin-test-js</artifactId>
      <scope>test</scope>
    </dependency>
  </dependencies>


  <build>
    <sourceDirectory>${project.basedir}/src/main/kotlin</sourceDirectory>
    <testSourceDirectory>${project.basedir}/src/test/kotlin</testSourceDirectory>

    <plugins>
      <plugin>
        <groupId>org.jetbrains.kotlin</groupId>
        <!--suppress KotlinMavenPluginPhase -->
        <artifactId>kotlin-maven-plugin</artifactId>

        <configuration combine.self="override">
          <!--<moduleKind>umd</moduleKind>-->
          <sourceMap>true</sourceMap>
          <sourceMapEmbedSources>always</sourceMapEmbedSources>

          <args>
            <arg>-progressive</arg>
            <arg>-Xmulti-platform</arg>
          </args>
        </configuration>

        <executions>
          <execution>
            <id>compile</id>
            <phase>none</phase>
          </execution>

          <execution>
            <id>compile-js</id>
            <phase>compile</phase>
            <goals>
              <goal>js</goal>
            </goals>

            <configuration>
<!--              <sourceMapPrefix>./</sourceMapPrefix>-->
<!--              <outputFile>${project.build.outputDirectory}/${project.artifactId}.js</outputFile>-->
<!--              <multiPlatform>true</multiPlatform>-->
              <sourceDirs>
                <sourceDir>${project.basedir}/src/main/kotlin</sourceDir>
                <sourceDir>${project.basedir}/src/main/sample-lib</sourceDir>
              </sourceDirs>
            </configuration>
          </execution>

          <execution>
            <id>test-compile</id>
            <phase>none</phase>
          </execution>

          <execution>
            <id>test-compile-js</id>
            <phase>test-compile</phase>
            <goals>
              <goal>test-js</goal>
            </goals>

            <configuration>
<!--              <outputFile>${project.basedir}/target/test-js/${project.artifactId}-tests.js</outputFile>-->
<!--              <metaInfo>true</metaInfo>-->
<!--              <sourceMap>true</sourceMap>-->
<!--              <moduleKind>umd</moduleKind>-->
<!--              <multiPlatform>true</multiPlatform>-->
            </configuration>

          </execution>
        </executions>
      </plugin>

      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>build-helper-maven-plugin</artifactId>
        <version>3.0.0</version>
        <executions>
          <execution>
            <id>add-sample-lib-source</id>
            <phase>generate-sources</phase>
            <goals>
              <goal>add-source</goal>
            </goals>
            <configuration>
              <sources>
                <sourceDir>${project.basedir}/src/main/sample-lib</sourceDir>
              </sources>
            </configuration>
          </execution>
        </executions>
      </plugin>


      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-jar-plugin</artifactId>
        <configuration>
          <forceCreation>true</forceCreation>
          <classesDirectory>${project.build.outputDirectory}</classesDirectory>
          <includes>
            <include>**/*.js</include>
            <include>**/*.js.map</include>
            <include>**/*.kjsm</include>
            <include>**/*.kotlin_classes</include>
            <include>**/*.kotlin_string_table</include>
            <include>**/*.kotlin_file_table</include>
          </includes>
          <archive>
            <forced />
            <manifestEntries>
              <Built-By>${user.name}</Built-By>

              <Implementation-Vendor>JetBrains s.r.o.</Implementation-Vendor>
              <Implementation-Version>${project.version}</Implementation-Version>
            </manifestEntries>
          </archive>
        </configuration>
      </plugin>

      <plugin>
        <artifactId>maven-dependency-plugin</artifactId>
        <executions>
<!--          <execution>-->
<!--            <id>unpack</id>-->
<!--            <phase>compile</phase>-->
<!--            <goals>-->
<!--              <goal>unpack</goal>-->
<!--            </goals>-->
<!--            <configuration>-->
<!--              <artifactItems>-->
<!--                <artifactItem>-->
<!--                  <groupId>org.jetbrains.kotlin</groupId>-->
<!--                  <artifactId>kotlin-stdlib-js</artifactId>-->
<!--                  <version>1.3.30</version>-->
<!--                  <outputDirectory>${project.build.directory}/js/lib</outputDirectory>-->
<!--                  <includes>*.js,*.js.map</includes>-->
<!--                </artifactItem>-->
<!--              </artifactItems>-->
<!--            </configuration>-->
<!--          </execution>-->

          <execution>
            <id>unpack-deps</id>
            <goals>
              <goal>unpack-dependencies</goal>
            </goals>
            <phase>compile</phase>
            <configuration>
              <includeScope>compile</includeScope>
              <excludeArtifactIds>sample-lib</excludeArtifactIds>
              <includeTypes>jar</includeTypes>
              <outputDirectory>${project.basedir}/target/js/lib</outputDirectory>
              <includes>*.js</includes>
              <excludes>*.meta.js</excludes>
              <excludes>*.js.map</excludes>
            </configuration>
          </execution>

          <execution>
            <id>unpack-test-deps</id>
            <goals>
              <goal>unpack-dependencies</goal>
            </goals>
            <phase>test-compile</phase>
            <configuration>
              <includeScope>test</includeScope>
              <excludeArtifactIds>sample-lib</excludeArtifactIds>
              <includeTypes>jar</includeTypes>
              <outputDirectory>${project.basedir}/target/test-js/lib</outputDirectory>
              <includes>*.js</includes>
              <excludes>*.meta.js</excludes>
            </configuration>
          </execution>
        </executions>
      </plugin>

    </plugins>
  </build>

</project>
